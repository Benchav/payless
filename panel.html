<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payless Shoes — Panel Administrativo</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#ff6b35; --muted:#98a0b3; --glass: rgba(255,255,255,0.03); --success:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#071029 0%, #0f1724 100%);color:#e6eef8;}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh;gap:24px;padding:28px;}
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03);}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#071022}
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    nav ul{list-style:none;padding:0;margin:14px 0}
    nav li{margin-bottom:8px}
    .branch-btn{width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;background:var(--glass);color:inherit;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .branch-btn:hover{transform:translateY(-2px)}
    .branch-name{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.04)}
    .open-link{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:13px;cursor:pointer}
    .open-link:hover{background:rgba(255,255,255,0.02)}
    main{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(2,6,23,0.5)}
    header.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit}
    .header-actions button{background:var(--card);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
    .card{padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .card h3{margin:0;font-size:14px;color:var(--muted)}
    .card p{margin:8px 0 0;font-size:22px;font-weight:600}
    .panel{display:flex;gap:16px}
    .left{flex:2}
    .right{flex:1}
    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
    th{color:var(--muted);font-weight:600}
    .branch-select{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#ff8a5b);color:#071022;border:none}
    @media (max-width:900px){.app{grid-template-columns:1fr;}.cards{grid-template-columns:repeat(2,1fr)}.panel{flex-direction:column}}
    .muted{color:var(--muted);font-size:13px}
    #spinnerOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:24px;color:white;display:none;z-index:9999;}
  </style>
</head>
<body>
  <div id="spinnerOverlay">Cargando datos...</div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">PS</div>
        <div>
          <h1>Payless — Admin</h1>
          <p>Panel central de sucursales</p>
        </div>
      </div>

      <nav>
        <ul>
          <li>
            <div class="branch-btn" data-branch="jinotepe" onclick="selectBranch('jinotepe')">
              <div class="branch-name"><strong>Jinotepe</strong><span class="muted">(Managua Sur)</span></div>
              <div style="display:flex;gap:8px">
                <button class="open-link" onclick="openProgram(event,'/jinotepe')">Abrir programa</button>
              </div>
            </div>
          </li>
          <li>
            <div class="branch-btn" data-branch="chontales" onclick="selectBranch('chontales')">
              <div class="branch-name"><strong>Chontales</strong><span class="muted">(Regional)</span></div>
              <div style="display:flex;gap:8px">
                <button class="open-link" onclick="openProgram(event,'/chontales')">Abrir programa</button>
              </div>
            </div>
          </li>
          <li>
            <div class="branch-btn" data-branch="masaya" onclick="selectBranch('masaya')">
              <div class="branch-name"><strong>Masaya</strong><span class="muted">(Centro)</span></div>
              <div style="display:flex;gap:8px">
                <button class="open-link" onclick="openProgram(event,'/masaya')">Abrir programa</button>
              </div>
            </div>
          </li>
        </ul>
      </nav>

      <div style="margin-top:18px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Acciones rápidas</div>
        <button class="btn" onclick="downloadAll()">Exportar registros (CSV)</button>
        <button class="btn" style="margin-top:8px" onclick="logout()">Cerrar sesión</button>
      </div>
    </aside>

    <main>
      <header class="main-header">
        <div>
          <h2 style="margin:0">Tablero administrativo</h2>
          <div class="muted">Información consolidada por sucursal</div>
        </div>
        <div class="header-actions">
          <div class="search">
            <input id="searchInput" placeholder="Buscar por cliente, ticket o producto" oninput="filterTable()" />
            <button class="btn" onclick="refreshData()">Actualizar</button>
          </div>
        </div>
      </header>

      <section class="cards">
        <div class="card">
          <h3>Ventas hoy</h3>
          <p id="ventasHoy">0</p>
          <div class="muted">Total combinado</div>
        </div>
        <div class="card">
          <h3>Registros</h3>
          <p id="registrosTotal">0</p>
          <div class="muted">Entradas en tablas</div>
        </div>
        <div class="card">
          <h3>Stock crítico</h3>
          <p id="stockCritico">0</p>
          <div class="muted">Productos por sucursal</div>
        </div>
      </section>

      <section class="panel">
        <div class="left">
          <div class="branch-select">
            <label class="muted">Sucursal:</label>
            <select id="branchSelect" onchange="onBranchChange()">
              <option value="all">Todas</option>
              <option value="jinotepe">Jinotepe</option>
              <option value="chontales">Chontales</option>
              <option value="masaya">Masaya</option>
            </select>
            <button class="btn primary" onclick="viewRecords()">Ver registros</button>
          </div>

          <div style="overflow:auto;border-radius:10px;background:transparent;padding:6px">
            <table id="recordsTable">
              <thead>
                <tr><th>Fecha</th><th>Sucursal</th><th>Ticket</th><th>Cliente</th><th>Monto</th><th>Acción</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <aside class="right">
          <div class="card" style="margin-bottom:12px">
            <h3>Detalles Sucursal</h3>
            <p id="detailBranch">Selecciona una sucursal</p>
          </div>

          <div class="card">
            <h3>Resumen rápido</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <div class="muted">Ventas (7 días): <strong id="weekSales">0</strong></div>
              <div class="muted">Clientes nuevos: <strong id="newClients">0</strong></div>
              <div class="muted">Tickets altos: <strong id="highTickets">0</strong></div>
            </div>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <script>
    const API_URL = 'https://payless-api.vercel.app/api/managua';

    function showLoading(show){
      document.getElementById('spinnerOverlay').style.display = show?'flex':'none';
    }

    async function fetchRecords(branch='all'){
      showLoading(true);
      try{
        const res = await fetch(API_URL);
        if(!res.ok) throw new Error('Error al obtener registros');
        let data = await res.json();
        if(branch!=='all') data = data.filter(r => r.branch === branch);
        return data;
      }catch(err){
        console.error(err);
        alert('No se pudieron cargar los registros de la API');
        return [];
      } finally{
        showLoading(false);
      }
    }

    async function viewRecords(){
      const sel = document.getElementById('branchSelect').value;
      const rows = await fetchRecords(sel);
      populateTable(rows);
      updateCards(rows);
      document.getElementById('detailBranch').innerText = sel==='all'?'Todas las sucursales':sel.charAt(0).toUpperCase()+sel.slice(1);
    }

    function populateTable(rows){
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date||'--'}</td>
          <td>${r.branch||'--'}</td>
          <td>${r.ticket||'--'}</td>
          <td>${r.cliente||'--'}</td>
          <td>$${(r.monto||0).toFixed(2)}</td>
          <td><button class='btn' onclick="viewTicket('${r.ticket}')">Ver</button></td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('registrosTotal').innerText = rows.length;
    }

    function updateCards(rows){
      const ventas = rows.reduce((s,r)=>s + (r.monto||0),0);
      const stock = Math.max(0,Math.floor(Math.random()*15));
      document.getElementById('ventasHoy').innerText = `$${ventas.toFixed(2)}`;
      document.getElementById('stockCritico').innerText = stock;
      document.getElementById('weekSales').innerText = `$${(ventas*1.2).toFixed(2)}`;
      document.getElementById('newClients').innerText = Math.floor(rows.length/2);
      document.getElementById('highTickets').innerText = rows.filter(r=>r.monto>100).length;
    }

    function selectBranch(name){
      document.querySelectorAll('.branch-btn').forEach(b=>b.style.outline='');
      const el = document.querySelector(`.branch-btn[data-branch="${name}"]`);
      if(el) el.style.outline='2px solid rgba(255,255,255,0.03)';
      document.getElementById('branchSelect').value = name;
      viewRecords();
    }

    function onBranchChange(){viewRecords();}
    function viewTicket(ticket){alert('Abrir detalle ticket: '+ticket);}
    function filterTable(){
      const q = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('#recordsTable tbody tr').forEach(r=>{
        r.style.display = r.innerText.toLowerCase().includes(q)?'table-row':'none';
      });
    }
    function refreshData(){viewRecords();}
    function downloadAll(){
      const rows = Array.from(document.querySelectorAll('#recordsTable tbody tr')).map(tr=>{
        const cells = tr.querySelectorAll('td');
        return `${cells[0].innerText},${cells[1].innerText},${cells[2].innerText},${cells[3].innerText},${cells[4].innerText}`;
      });
      const csv = ['fecha,sucursal,ticket,cliente,monto', ...rows].join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='registros_payless.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function openProgram(ev,url){ev.stopPropagation(); window.open(url,'_blank');}
    function logout(){window.location.href='index.html';}

    // init
    viewRecords();
  </script>
</body>
</html>